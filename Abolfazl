import time
import random
import numpy as np
from selenium import webdriver
from selenium.webdriver.common.by import By
from telegram import Bot
from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import StandardScaler
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Dense

# اطلاعات ربات تلگرام
TELEGRAM_TOKEN = '7597780702:AAFHOosF6-OGZMVQkz_quqEUv1ZgbXuW2Fk'
CHAT_ID = '6723345169'

# تنظیمات WebDriver
options = webdriver.ChromeOptions()
options.add_argument("--headless")  # اجرا بدون نمایش مرورگر
options.add_argument("--no-sandbox")
options.add_argument("--disable-dev-shm-usage")
driver = webdriver.Chrome(executable_path='/usr/lib/chromium-browser/chromedriver', options=options)

# متغیر بررسی آماده بودن سایت
SITE_URL = 'https://bc.game/fa/game/crash'
READY = False

# تابع بررسی آماده بودن سایت
def wait_for_site_ready():
    global READY
    while not READY:
        try:
            print("در حال بررسی دسترسی به سایت...")
            driver.get(SITE_URL)
            time.sleep(5)  # توقف کوتاه برای بارگذاری سایت
            # بررسی وجود یک عنصر خاص در صفحه
            element = driver.find_element(By.ID, "game-multiplier")
            if element:
                READY = True
                print("سایت آماده است، شروع به کار...")
        except Exception as e:
            print("سایت هنوز آماده نیست. تلاش مجدد...")
            time.sleep(10)  # چند ثانیه دیگر صبر کنید

# استخراج داده‌ها (ضریب‌ها)
def get_game_data():
    try:
        crash_multiplier = driver.find_element(By.ID, "game-multiplier").text
        return float(crash_multiplier)
    except Exception as e:
        print("خطا در استخراج داده‌ها:", e)
        return None

# ارسال نتیجه به ربات تلگرام
def send_to_telegram(message):
    bot = Bot(token=TELEGRAM_TOKEN)
    bot.send_message(chat_id=CHAT_ID, text=message)

# پیش‌بینی ضریب با رگرسیون خطی
def linear_regression_predict(data):
    if len(data) < 5:
        return random.uniform(0.1, 1000.0)
    X = np.array(range(len(data))).reshape(-1, 1)
    y = np.array(data).reshape(-1, 1)
    reg = LinearRegression()
    reg.fit(X, y)
    next_index = len(data)
    prediction = reg.predict([[next_index]])
    return max(0.1, min(prediction[0][0], 1000.0))  # محدود کردن پیش‌بینی به بازه 0.1 تا 1000

# پیش‌بینی ضریب با شبکه عصبی
def neural_network_predict(data):
    if len(data) < 5:
        return random.uniform(0.1, 1000.0)
    X = np.array(range(len(data))).reshape(-1, 1)
    y = np.array(data).reshape(-1, 1)
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(X)
    model = Sequential()
    model.add(Dense(64, input_dim=1, activation='relu'))
    model.add(Dense(32, activation='relu'))
    model.add(Dense(1))
    model.compile(loss='mse', optimizer='adam')
    model.fit(X_scaled, y, epochs=200, batch_size=5, verbose=0)
    next_index = len(data)
    prediction = model.predict(scaler.transform([[next_index]]))
    return max(0.1, min(prediction[0][0], 1000.0))  # محدود کردن پیش‌بینی به بازه 0.1 تا 1000

# پیش‌بینی ضریب با میانگین متحرک
def predict_next_multiplier(data):
    if len(data) >= 5:
        avg = sum(data[-5:]) / 5
        return max(0.1, min(avg + random.uniform(0, 0.5), 1000.0))  # محدود کردن پیش‌بینی به بازه 0.1 تا 1000
    else:
        return random.uniform(0.1, 1000.0)

# اجرای برنامه اصلی
def main():
    wait_for_site_ready()  # صبر برای آماده شدن سایت
    history = []
    while True:
        crash_multiplier = get_game_data()
        if crash_multiplier:
            print(f"ضریب فعلی: {crash_multiplier}")
            history.append(crash_multiplier)
            next_multiplier_linear = linear_regression_predict(history)
            next_multiplier_nn = neural_network_predict(history)
            next_multiplier_avg = predict_next_multiplier(history)
            print(f"پیش‌بینی ضریب بعدی (رگرسیون خطی): {next_multiplier_linear
